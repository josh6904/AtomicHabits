<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atomic Habits Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Build better habits with the Atomic System - Track, analyze, and improve your daily habits">
    <meta name="theme-color" content="#00ff9d">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Atomic Habits">
    
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Atomic Habits">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-72x72.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-72x72.png">
    <style>
        :root {
            /* Dynamic Variables Updated via JS */
            --bg-body: #000000;
            --bg-card: #111111;
            --bg-input: #1f1f1f;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --accent: #00ff9d; /* Default: Cyber Green */
            --accent-dim: rgba(0, 255, 157, 0.1);
            --danger: #ff4757;
            --warning: #ffa502;
            --success: #2ed573;
            --info: #3b82f6;
            --border-radius: 16px;
            --transition-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            user-select: auto; 
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #222;
            border-right: 1px solid #222;
        }

        /* --- Header & Dashboard --- */
        header {
            padding: 1.2rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--bg-input);
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .header-left h1 { 
            font-size: 1.2rem; 
            font-weight: 700; 
            letter-spacing: -0.02em; 
            margin-bottom: 4px;
        }
        .header-left .subtitle { 
            color: var(--accent); 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em; 
        }
        
        .sync-status { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 0.7rem; 
            color: var(--text-secondary); 
        }
        .sync-dot { 
            width: 8px; 
            height: 8px; 
            background: var(--text-secondary); 
            border-radius: 50%; 
            transition: 0.3s; 
        }
        .sync-dot.active { 
            background: var(--accent); 
            box-shadow: 0 0 8px var(--accent); 
        }

        /* --- Dashboard Stats --- */
        .dashboard-stats {
            display: flex;
            justify-content: space-around;
            padding: 1rem 1.5rem;
            background: rgba(0,0,0,0.7);
            border-bottom: 1px solid var(--bg-input);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--bg-input);
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            transition: 0.2s;
            flex: 1;
        }

        .nav-item.active {
            color: var(--accent);
            transform: translateY(-2px);
        }

        .nav-icon {
            font-size: 1.4rem;
        }

        .fab {
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            width: 56px;
            height: 56px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
            font-size: 1.8rem;
            font-weight: 700;
            box-shadow: 0 4px 20px var(--accent-dim);
            cursor: pointer;
            transition: var(--transition-bounce);
            z-index: 60;
            border: 4px solid var(--bg-body);
        }

        .fab:active {
            transform: translateX(-50%) scale(0.9);
        }

        /* --- Hide old tabs --- */
        .view-tabs { display: none; }

        /* --- Content Area --- */
        .content-area {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .view-container {
            display: none;
            padding: 1rem;
            padding-bottom: 100px;
            flex-direction: column;
            gap: 1rem;
        }

        .view-container.active {
            display: flex;
        }

        /* --- Habit List --- */
        .habit-list { 
            list-style: none; 
            display: flex; 
            flex-direction: column; 
            gap: 0.8rem; 
        }

        .habit-item {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 1.2rem;
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
            transition: transform 0.2s var(--transition-smooth);
            border: 1px solid rgba(255,255,255,0.05);
            border-left-width: 4px;
        }

        .habit-item[data-type="good"] { border-left-color: var(--accent); }
        .habit-item[data-type="bad"] { border-left-color: var(--danger); }
        .habit-item[data-type="neutral"] { border-left-color: var(--text-secondary); }

        .habit-item.swiping { transition: none; }
        
        .swipe-bg-right { 
            position: absolute; 
            top: 0; 
            right: 0; 
            bottom: 0; 
            width: 100%; 
            background: var(--accent); 
            z-index: 0; 
            transform: translateX(100%); 
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            padding-right: 2rem; 
            color: black; 
            font-weight: 700; 
            font-size: 1.2rem; 
        }
        .swipe-bg-left { 
            position: absolute; 
            top: 0; 
            left: 0; 
            bottom: 0; 
            width: 100%; 
            background: var(--danger); 
            z-index: 0; 
            transform: translateX(-100%); 
            display: flex; 
            align-items: center; 
            justify-content: flex-start; 
            padding-left: 2rem; 
            color: white; 
            font-weight: 700; 
            font-size: 1.2rem; 
        }
        
        .habit-content { 
            position: relative; 
            z-index: 1; 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            background: var(--bg-card); 
            width: 100%; 
        }
        .habit-info { flex: 1; }
        .habit-name { 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin-bottom: 8px; 
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .priority-stars {
            color: gold;
            font-size: 0.9rem;
        }

        .habit-meta { 
            font-size: 0.75rem; 
            color: var(--text-secondary); 
            display: flex; 
            gap: 8px; 
            align-items: center;
            flex-wrap: wrap;
        }
        
        .badge {
            display: inline-block;
            font-size: 0.65rem;
            background: var(--accent-dim);
            padding: 3px 8px;
            border-radius: 12px;
            color: var(--accent);
        }

        .goal-badge {
            font-size: 0.75rem;
            background: rgba(0, 255, 157, 0.2);
            color: var(--accent);
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 700;
        }

        .identity-pill { 
            display: inline-block; 
            font-size: 0.65rem; 
            background: rgba(255,255,255,0.1); 
            padding: 3px 8px; 
            border-radius: 12px; 
            color: #ccc; 
        }

        .category-pill {
            display: inline-block;
            font-size: 0.65rem;
            background: rgba(59, 130, 246, 0.2);
            padding: 3px 8px;
            border-radius: 12px;
            color: #3b82f6;
        }

        /* --- Progress Bar --- */
        .habit-progress {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }

        .habit-progress-bar {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* --- Quick Action Buttons --- */
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 10px;
        }

        .quick-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .quick-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* --- Analytics View --- */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .analytics-card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 1.2rem;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .analytics-card .stat-value {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .heatmap {
            display: grid;
            grid-template-columns: repeat(53, 1fr);
            grid-template-rows: repeat(7, 1fr);
            gap: 2px;
            margin-top: 1rem;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .heatmap-day {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 1px;
            background: rgba(255,255,255,0.05);
            transition: transform 0.1s;
            cursor: pointer;
        }

        .heatmap-day:hover {
            transform: scale(1.5);
            z-index: 10;
        }

        .heatmap-day.active-1 { background: var(--accent); opacity: 0.2; }
        .heatmap-day.active-2 { background: var(--accent); opacity: 0.4; }
        .heatmap-day.active-3 { background: var(--accent); opacity: 0.6; }
        .heatmap-day.active-4 { background: var(--accent); opacity: 0.8; }
        .heatmap-day.active-5 { background: var(--accent); box-shadow: 0 0 5px var(--accent); }

        #tooltip { 
            position: fixed; 
            background: var(--bg-card); 
            border: 1px solid var(--bg-input); 
            color: var(--text-primary); 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-size: 0.8rem; 
            pointer-events: none; 
            display: none; 
            z-index: 1000; 
            white-space: nowrap; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
            transform: translate(-50%, -100%);
            margin-top: -10px;
        }

        /* --- Focus Mode --- */
        #focusOverlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: black; 
            z-index: 100;
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            text-align: center;
        }
        #focusOverlay.active { 
            display: flex; 
            animation: fadeIn 0.5s ease; 
        }
        .focus-habit-name { 
            font-size: 2.5rem; 
            font-weight: 800; 
            margin-bottom: 2rem; 
            line-height: 1.1; 
            padding: 0 1rem;
        }
        .focus-actions { 
            display: flex; 
            gap: 2rem; 
            margin-top: 2rem;
        }
        .focus-btn { 
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            border: 2px solid var(--bg-input); 
            background: transparent; 
            color: white; 
            font-size: 1.5rem; 
            cursor: pointer; 
            transition: 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .focus-btn:active { 
            transform: scale(0.9); 
            background: var(--bg-input); 
        }
        .focus-btn.complete { 
            border-color: var(--accent); 
            color: var(--accent); 
        }
        .focus-btn.skip { 
            border-color: var(--text-secondary); 
            color: var(--text-secondary); 
        }
        .focus-close { 
            position: absolute; 
            top: 2rem; 
            right: 2rem; 
            font-size: 1.5rem; 
            color: var(--text-secondary); 
            cursor: pointer; 
        }

        .focus-timer-section { margin: 2rem 0; display: flex; flex-direction: column; align-items: center; opacity: 0.9; }
        #focusTimerDisplay { 
            font-size: 5rem; 
            font-weight: 300; 
            font-variant-numeric: tabular-nums; 
            margin-bottom: 1.5rem; 
            color: var(--accent); 
            text-shadow: 0 0 20px var(--accent-dim); 
            transition: color 0.2s;
        }
        .focus-timer-controls { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
        .focus-timer-btn { background: transparent; border: 1px solid var(--bg-input); color: var(--text-secondary); padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .focus-timer-btn:active { background: var(--bg-input); color: white; }
        .focus-timer-btn.running { border-color: var(--danger); color: var(--danger); }
        .streak-fire { color: #f59e0b; }

        .pomodoro-btn:active {
            background: var(--accent);
            color: black;
        }

        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--bg-input);
            padding: 1rem;
            display: flex; 
            justify-content: space-around; 
            z-index: 50;
        }

        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px; 
            color: var(--text-secondary); 
            font-size: 0.7rem; 
            cursor: pointer; 
            transition: 0.2s; 
        }
        .nav-item.active { 
            color: var(--text-primary); 
            transform: translateY(-2px); 
        }
        .nav-icon { 
            font-size: 1.5rem; 
        }

        .fab {
            position: absolute; 
            top: -24px; 
            left: 50%; 
            transform: translateX(-50%);
            width: 56px; 
            height: 56px; 
            background: var(--accent); 
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            color: black; 
            font-size: 1.5rem; 
            font-weight: 700;
            box-shadow: 0 4px 12px var(--accent-dim);
            cursor: pointer; 
            transition: var(--transition-bounce);
        }
        .fab:active { 
            transform: translateX(-50%) scale(0.9); 
        }

        /* --- Modal System --- */
        .modal-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.9); 
            backdrop-filter: blur(10px);
            z-index: 200; 
            display: none; 
            align-items: center; 
            justify-content: center;
            padding: 1rem;
        }
        .modal-card {
            background: var(--bg-card); 
            width: 100%; 
            max-width: 400px;
            padding: 1.5rem; 
            border-radius: 20px; 
            border: 1px solid #333;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        input, select, textarea {
            width: 100%; 
            background: #111; 
            border: 1px solid #333;
            padding: 12px; 
            border-radius: 12px; 
            color: white; 
            font-size: 1rem;
            outline: none; 
            transition: 0.2s;
        }
        input:focus, select:focus { 
            border-color: var(--accent); 
        }
        
        .btn-block { 
            width: 100%; 
            padding: 14px; 
            background: var(--accent); 
            color: black; 
            font-weight: 700; 
            border: none; 
            border-radius: 12px; 
            margin-top: 1rem; 
            cursor: pointer; 
            transition: 0.2s;
        }
        .btn-block:active {
            transform: scale(0.98);
        }
        
        .btn-outline { 
            width: 100%; 
            padding: 12px; 
            background: transparent; 
            border: 1px solid #444; 
            color: #ccc; 
            border-radius: 12px; 
            margin-top: 0.5rem; 
            cursor: pointer; 
            font-size: 0.9rem; 
            transition: 0.2s;
        }
        .btn-outline:active {
            background: rgba(255,255,255,0.1);
        }
        .btn-danger { 
            color: var(--danger); 
            border-color: var(--danger); 
        }

        /* Theme Picker */
        .theme-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr);
            gap: 0.8rem; 
            margin-bottom: 1rem; 
        }
        .theme-dot { 
            width: 100%; 
            aspect-ratio: 1;
            border-radius: 12px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: 0.2s; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .theme-dot.selected { 
            border-color: white; 
            transform: scale(1.05); 
        }

        /* Switch Toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Achievement Badges */
        .badge-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .achievement-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            text-align: center;
        }

        .achievement-badge.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .badge-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .badge-title {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .badge-desc {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            margin-top: 4rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Animations */
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        @keyframes slideUp { 
            from { transform: translateY(50px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Achievement Popup */
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            z-index: 1000;
            text-align: center;
            display: none;
            border: 2px solid var(--accent);
            box-shadow: 0 0 40px rgba(0, 255, 157, 0.3);
            animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .achievement-popup.active {
            display: block;
        }

        /* Hidden file input for restore */
        #restoreInput { display: none; }

        /* Responsive */
        @media (max-width: 480px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .focus-habit-name {
                font-size: 2rem;
            }
            
            .focus-btn {
                width: 70px;
                height: 70px;
            }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="header-left">
                <span class="subtitle" id="greeting">System V8</span>
                <h1>Atomic Habits</h1>
            </div>
            <div class="sync-status">
                <span id="syncText">Local</span>
                <div class="sync-dot" id="syncDot"></div>
            </div>
        </header>

        <!-- Dashboard Stats -->
        <div class="dashboard-stats" id="dashboardStats">
            <div class="stat-item">
                <div class="stat-value" id="todayCompletion">0%</div>
                <div class="stat-label">Today</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="currentStreak">0</div>
                <div class="stat-label">Day Streak</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalHabits">0</div>
                <div class="stat-label">Habits</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="successRate">0%</div>
                <div class="stat-label">Success Rate</div>
            </div>
        </div>

        <!-- Content Area with Views -->
        <div class="content-area" id="contentArea">
            <!-- Today View -->
            <div class="view-container active" id="todayView">
                <ul class="habit-list" id="habitList"></ul>
                <div class="empty-state" id="emptyState" style="display:none;">
                    <div class="empty-icon">üå±</div>
                    <p>No active habits. Create your first atomic habit!</p>
                </div>
            </div>

            <!-- Analytics View -->
            <div class="view-container" id="analyticsView">
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="stat-value" id="totalCompletions">0</div>
                        <div class="stat-label">Total Completions</div>
                    </div>
                    <div class="analytics-card">
                        <div class="stat-value" id="bestStreak">0</div>
                        <div class="stat-label">Best Streak</div>
                    </div>
                    <div class="analytics-card">
                        <div class="stat-value" id="activeDays">0</div>
                        <div class="stat-label">Active Days (1Y)</div>
                    </div>
                    <div class="analytics-card">
                        <div class="stat-value" id="bestDay">--</div>
                        <div class="stat-label">Best Day (Count)</div>
                    </div>
                    <div class="analytics-card">
                        <div class="stat-value" id="avgCompletion">0%</div>
                        <div class="stat-label">Avg. Daily</div>
                    </div>
                    <div class="analytics-card">
                        <div class="stat-value" id="consistencyScore">0%</div>
                        <div class="stat-label">Consistency</div>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <div class="stat-label">Weekly Heatmap</div>
                    <div class="heatmap" id="weeklyHeatmap"></div>
                </div>
                
                <div class="analytics-card">
                    <div class="stat-label">Best Time of Day</div>
                    <div style="margin-top: 1rem; height: 100px; display: flex; align-items: flex-end; gap: 4px;" id="timeChart">
                        <!-- Time bars will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Achievements View -->
            <div class="view-container" id="achievementsView">
                <div class="badge-grid" id="achievementsGrid"></div>
                <div class="empty-state" id="noAchievements" style="display:none;">
                    <div class="empty-icon">üèÜ</div>
                    <p>Complete habits to unlock achievements!</p>
                </div>
            </div>

            <!-- Habit Stacks View -->
            <div class="view-container" id="stacksView">
                <div style="margin-bottom: 1rem;">
                    <button class="btn-outline" onclick="window.app.openStackModal()" style="width: auto; display: inline-flex; align-items: center; gap: 8px;">
                        Ôºã Create Stack
                    </button>
                </div>
                <div id="stacksList"></div>
                <div class="empty-state" id="noStacks" style="display:none;">
                    <div class="empty-icon">üîó</div>
                    <p>No habit stacks yet. Group related habits together!</p>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-view="today" onclick="window.app.switchView('today')">
                <div class="nav-icon">üìÖ</div>
                <span>Today</span>
            </div>
            <div class="nav-item" data-view="analytics" onclick="window.app.switchView('analytics')">
                <div class="nav-icon">üìä</div>
                <span>Insights</span>
            </div>
            
            <div class="fab" onclick="window.app.openAddModal()">Ôºã</div>
            
            <div class="nav-item" data-view="stacks" onclick="window.app.switchView('stacks')">
                <div class="nav-icon">üìö</div>
                <span>Stacks</span>
            </div>
            <div class="nav-item" onclick="window.app.openSettings()">
                <div class="nav-icon">‚öôÔ∏è</div>
                <span>Settings</span>
            </div>
        </nav>
    </div>

    <!-- PART 2 CONTINUES... -->
         <!-- Micro-App: Focus Mode -->
    <div id="focusOverlay">
        <div class="focus-close" onclick="window.app.stopFocusMode()">‚úï</div>
        <div style="color: var(--text-secondary); margin-bottom: 1rem; letter-spacing: 0.1em; text-transform: uppercase;">Focus Mode</div>
        <div class="focus-habit-name" id="focusHabitName">Loading...</div>
        
        <!-- Pomodoro Timer -->
        <div class="pomodoro-timer" id="pomodoroTimer">25:00</div>
        
        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
            Focus on this habit for 25 minutes
        </div>
        
        <div class="focus-actions">
            <button class="focus-btn skip" onclick="window.app.focusSkip()">Skip</button>
            <div class="pomodoro-controls">
                <button class="pomodoro-btn" onclick="window.app.startPomodoro()" id="startTimerBtn">Start</button>
                <button class="pomodoro-btn" onclick="window.app.pausePomodoro()" id="pauseTimerBtn" style="display:none;">Pause</button>
                <button class="pomodoro-btn" onclick="window.app.resetPomodoro()">Reset</button>
            </div>
            <button class="focus-btn complete" onclick="window.app.focusComplete()">Done</button>
        </div>
        
        <div style="margin-top: 2rem; font-size: 0.8rem; color: var(--text-secondary);">
            <div>Session: <span id="focusSessions">0</span> completed today</div>
        </div>
    </div>

    <!-- Add/Edit Habit Modal -->
    <div id="addModal" class="modal-overlay" onclick="window.app.closeModal(event, 'addModal')">
        <div class="modal-card">
            <h2 style="margin-bottom: 1.5rem;" id="modalTitle">New Atomic Habit</h2>
            <form id="habitForm">
                <input type="hidden" id="habitId">
                
                <div class="form-group">
                    <label class="form-label">I will...</label>
                    <input type="text" id="habitName" placeholder="e.g., Read for 20 minutes" required autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Because I am a...</label>
                    <input type="text" id="habitIdentity" placeholder="e.g., reader, athlete, mindful person" autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="habitPriority">
                        <option value="1">‚≠ê Low Priority</option>
                        <option value="2">‚≠ê‚≠ê Medium-Low</option>
                        <option value="3" selected>‚≠ê‚≠ê‚≠ê Medium</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê High</option>
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Critical</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Habit Type</label>
                    <select id="habitType">
                        <option value="good" selected>üü¢ Good Habit (Positive)</option>
                        <option value="bad">üî¥ Bad Habit (Abstinence)</option>
                        <option value="neutral">‚ö™ Neutral Habit</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="habitCategory">
                        <option value="health">üè• Health & Fitness</option>
                        <option value="work">üíº Work & Career</option>
                        <option value="learning">üìö Learning</option>
                        <option value="mindfulness">üßò Mindfulness</option>
                        <option value="relationships">‚ù§Ô∏è Relationships</option>
                        <option value="finance">üí∞ Finance</option>
                        <option value="creativity">üé® Creativity</option>
                        <option value="other">üì¶ Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Difficulty</label>
                    <select id="habitDifficulty">
                        <option value="easy">Easy (2-minute rule)</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard (Requires effort)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Daily Reminder</label>
                    <input type="time" id="habitReminder" value="09:00">
                </div>

                <div class="form-group">
                    <label class="form-label">Focus Duration (minutes)</label>
                    <input type="number" id="habitTimer" value="25" min="1" max="120">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Daily Goal (completions)</label>
                    <input type="number" id="habitGoal" value="1" min="1" max="10">
                </div>
                
                <button type="submit" class="btn-block">Save to System</button>
                <button type="button" class="btn-outline" onclick="window.app.closeModal(event, 'addModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Quick Add Modal -->
    <div id="quickAddModal" class="modal-overlay" onclick="window.app.closeModal(event, 'quickAddModal')">
        <div class="modal-card">
            <h2 style="margin-bottom: 1.5rem;">Quick Add Habit</h2>
            <div style="margin-bottom: 1.5rem;">
                <input type="text" id="quickHabitName" placeholder="I will..." style="margin-bottom: 1rem;" autocomplete="off">
                <button class="btn-block" onclick="window.app.saveQuickHabit()">Add & Continue</button>
                <button class="btn-outline" onclick="window.app.closeModal(event, 'quickAddModal')">Cancel</button>
            </div>
            
            <div style="border-top: 1px solid #333; padding-top: 1rem;">
                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Quick Suggestions:</div>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <button class="quick-btn" onclick="document.getElementById('quickHabitName').value='Drink water first thing in morning'">üíß Morning Water</button>
                    <button class="quick-btn" onclick="document.getElementById('quickHabitName').value='Read 10 pages'">üìñ Read 10 Pages</button>
                    <button class="quick-btn" onclick="document.getElementById('quickHabitName').value='15 minute walk'">üö∂ 15 Min Walk</button>
                    <button class="quick-btn" onclick="document.getElementById('quickHabitName').value='5 minute meditation'">üßò 5 Min Meditation</button>
                    <button class="quick-btn" onclick="document.getElementById('quickHabitName').value='Plan tomorrow'">üìù Plan Tomorrow</button>
                    <button class="quick-btn" onclick="document.getElementById('quickHabitName').value='No phone first hour'">üìµ No Phone 1st Hour</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay" onclick="window.app.closeModal(event, 'settingsModal')">
        <div class="modal-card">
            <h2 style="margin-bottom: 1.5rem;">System Settings</h2>
            
            <!-- Themes -->
            <div style="margin-bottom: 1.5rem;">
                <div class="form-label">Theme Color</div>
                <div class="theme-grid">
                    <div class="theme-dot selected" style="background: #00ff9d;" onclick="window.app.setTheme('#00ff9d', this)">‚óè</div>
                    <div class="theme-dot" style="background: #3b82f6;" onclick="window.app.setTheme('#3b82f6', this)">‚óè</div>
                    <div class="theme-dot" style="background: #f59e0b;" onclick="window.app.setTheme('#f59e0b', this)">‚óè</div>
                    <div class="theme-dot" style="background: #ec4899;" onclick="window.app.setTheme('#ec4899', this)">‚óè</div>
                    <div class="theme-dot" style="background: #8b5cf6;" onclick="window.app.setTheme('#8b5cf6', this)">‚óè</div>
                    <div class="theme-dot" style="background: #10b981;" onclick="window.app.setTheme('#10b981', this)">‚óè</div>
                    <div class="theme-dot" style="background: #ef4444;" onclick="window.app.setTheme('#ef4444', this)">‚óè</div>
                    <div class="theme-dot" style="background: #ffffff;" onclick="window.app.setTheme('#ffffff', this)">‚óè</div>
                </div>
            </div>

            <!-- App Settings -->
            <div style="margin-bottom: 1.5rem;">
                <div class="form-label">App Preferences</div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <span>Show Completed Habits</span>
                    <label class="switch">
                        <input type="checkbox" id="showCompletedToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <span>Focus Timer Enabled</span>
                    <label class="switch">
                        <input type="checkbox" id="focusTimerToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <span>Haptic Feedback</span>
                    <label class="switch">
                        <input type="checkbox" id="hapticToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <!-- Data Management -->
            <div>
                <div class="form-label">Data Safety</div>
                <button class="btn-outline" onclick="window.app.exportData()">‚¨á Download Backup (.json)</button>
                <button class="btn-outline" onclick="document.getElementById('restoreInput').click()">‚¨Ü Restore from Backup</button>
                <input type="file" id="restoreInput" accept=".json" onchange="window.app.restoreData(this)">
            </div>

            <div style="margin-top: 2rem; border-top: 1px solid #333; padding-top: 1rem;">
                <button class="btn-outline btn-danger" onclick="window.app.resetData()">‚ò† Factory Reset</button>
            </div>
        </div>
    </div>

    <!-- Stack Modal -->
    <div id="stackModal" class="modal-overlay" onclick="window.app.closeModal(event, 'stackModal')">
        <div class="modal-card">
            <h2 style="margin-bottom: 1.5rem;" id="stackModalTitle">Create Habit Stack</h2>
            <form id="stackForm">
                <input type="hidden" id="stackId">
                
                <div class="form-group">
                    <label class="form-label">Stack Name</label>
                    <input type="text" id="stackName" placeholder="e.g., Morning Routine, Work Focus" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="stackDescription" placeholder="What's this stack about?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Habits</label>
                    <div id="stackHabitSelector" style="max-height: 200px; overflow-y: auto; background: #111; border-radius: 8px; padding: 0.5rem;">
                        <!-- Habit checkboxes will be inserted here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Trigger (After I...)</label>
                    <input type="text" id="stackTrigger" placeholder="e.g., After I wake up, After lunch">
                </div>
                
                <button type="submit" class="btn-block">Save Stack</button>
                <button type="button" class="btn-outline" onclick="window.app.closeModal(event, 'stackModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="tooltip"></div>

    <!-- Note Modal -->
    <div id="noteModal" class="modal-overlay" onclick="window.app.closeModal(event, 'noteModal')">
        <div class="modal-card">
            <h2 style="margin-bottom: 1.5rem;">Daily Reflection</h2>
            <p id="noteHabitName" style="color: var(--accent); margin-bottom: 1rem;"></p>
            <textarea id="noteTextarea" placeholder="How did this feel? What barriers appeared?" style="width: 100%; height: 150px; background: #111; border: 1px solid #333; border-radius: 8px; color: white; padding: 10px; margin-bottom: 1rem;"></textarea>
            <button type="button" class="btn-block" onclick="window.app.saveNote()">Save Reflection</button>
            <button type="button" class="btn-outline" onclick="window.app.closeModal(null, 'noteModal')">Cancel</button>
        </div>
    </div>

    <!-- Achievement Popup -->
    <div id="achievementPopup" class="achievement-popup">
        <div class="badge-icon" id="popupBadgeIcon">üèÜ</div>
        <h3 style="margin: 1rem 0 0.5rem;" id="popupBadgeTitle">Achievement Unlocked!</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;" id="popupBadgeDesc">Description</p>
        <button class="btn-outline" onclick="document.getElementById('achievementPopup').classList.remove('active')">Awesome!</button>
    </div>

    <canvas id="confetti" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999;"></canvas>

    <script>
        window.app = {
            // Enhanced Data Structure
            data: { 
                habits: [],
                stacks: [],
                achievements: [],
                settings: {
                    theme: '#00ff9d',
                    showCompleted: true,
                    focusTimer: true,
                    haptic: true,
                    sortBy: 'priority',
                    dailyGoal: 5,
                    pomodoroLength: 25,
                    breakLength: 5
                },
                stats: {
                    totalCompletions: 0,
                    currentStreak: 0,
                    bestStreak: 0,
                    successRate: 0,
                    lastActiveDate: null,
                    focusSessionsToday: 0
                },
                version: 'v8'
            },
            
            // State Management
            currentView: 'today',
            touchStartX: 0,
            touchCurrentX: 0,
            touchItem: null,
            currentFocusIndex: 0,
            pomodoroInterval: null,
            pomodoroTime: 1500, // 25 minutes in seconds
            pomodoroRunning: false,
            
            // Achievement Definitions
            achievementsDef: [
                { id: 'first_habit', icon: 'üå±', title: 'Seed Planter', desc: 'Create your first habit', unlocked: false },
                { id: 'streak_3', icon: 'üî•', title: 'On Fire', desc: '3 day streak on any habit', unlocked: false },
                { id: 'streak_7', icon: 'üåü', title: 'Weekly Warrior', desc: '7 day streak on any habit', unlocked: false },
                { id: 'streak_30', icon: 'üèÜ', title: 'Master of Consistency', desc: '30 day streak on any habit', unlocked: false },
                { id: 'complete_all', icon: '‚úÖ', title: 'Perfect Day', desc: 'Complete all habits in one day', unlocked: false },
                { id: 'morning_person', icon: 'üåÖ', title: 'Morning Person', desc: 'Complete 5 habits before 9 AM', unlocked: false },
                { id: 'weekend_hero', icon: 'üéØ', title: 'Weekend Hero', desc: 'Maintain streak over weekend', unlocked: false },
                { id: 'category_master', icon: 'üéñÔ∏è', title: 'Category Master', desc: 'Complete habits in all categories', unlocked: false },
                { id: 'focus_expert', icon: '‚è±Ô∏è', title: 'Focus Expert', desc: 'Complete 10 focus sessions', unlocked: false },
                { id: 'habit_stacker', icon: 'üîó', title: 'Habit Stacker', desc: 'Create 3 habit stacks', unlocked: false }
            ],

            init() {
                // Load Data
                this.loadData();
                
                // Load Theme
                this.loadTheme();
                
                // Load Settings
                this.loadSettings();
                
                // Context Greeting
                this.updateGreeting();
                
                // Setup Event Listeners
                this.setupEventListeners();
                
                // Initial Render
                this.renderDashboard();
                this.renderList();
                this.renderAchievements();
                this.renderStacks();
                this.updateAnalytics();
                
                // Request Notification Permission
                if ('Notification' in window && Notification.permission === 'default') {
                    setTimeout(() => {
                        Notification.requestPermission();
                    }, 2000);
                }
                
                // Check for achievements
                this.checkAchievements();
            },

            // --- Data Management ---
            loadData() {
                try {
                    const stored = localStorage.getItem('atomicV8');
                    if(stored) {
                        const parsed = JSON.parse(stored);
                        this.data = { ...this.data, ...parsed };
                        
                        // Migrate from old versions if needed
                        this.migrateData();
                    }
                } catch(e) { 
                    console.error('Load error:', e);
                    // Initialize with default data
                    this.save();
                }
            },

            migrateData() {
                // Migrate habits from old structure
                if (this.data.habits && this.data.habits.length > 0) {
                    this.data.habits = this.data.habits.map(habit => {
                        if (!habit.priority) habit.priority = 3;
                        if (!habit.category) habit.category = 'other';
                        if (!habit.difficulty) habit.difficulty = 'medium';
                        if (!habit.createdAt) habit.createdAt = Date.now();
                        if (!habit.timerDuration) habit.timerDuration = 25;
                        if (!habit.notes) habit.notes = {};
                        return habit;
                    });
                }
                
                // Initialize stacks if missing
                if (!this.data.stacks) this.data.stacks = [];
                
                // Initialize achievements if missing
                if (!this.data.achievements) {
                    this.data.achievements = this.achievementsDef.map(a => ({ ...a, unlocked: false }));
                }
            },

            save() {
                const dot = document.getElementById('syncDot');
                const text = document.getElementById('syncText');
                dot.classList.add('active');
                text.textContent = "Saving...";
                
                // Update stats before saving
                this.updateStats();
                
                setTimeout(() => {
                    try {
                        localStorage.setItem('atomicV8', JSON.stringify(this.data));
                        text.textContent = "Synced";
                        
                        // Update dashboard
                        this.renderDashboard();
                        
                        setTimeout(() => {
                            dot.classList.remove('active');
                            text.textContent = "Local";
                        }, 2000);
                    } catch(e) {
                        text.textContent = "Error";
                        console.error('Save error:', e);
                    }
                }, 300);
            },

            loadSettings() {
                const settings = this.data.settings;
                
                // Update toggle states
                document.getElementById('showCompletedToggle').checked = settings.showCompleted;
                document.getElementById('focusTimerToggle').checked = settings.focusTimer;
                document.getElementById('hapticToggle').checked = settings.haptic;
                
                // Add event listeners for toggles
                document.getElementById('showCompletedToggle').addEventListener('change', (e) => {
                    settings.showCompleted = e.target.checked;
                    this.save();
                    this.renderList();
                });
                
                document.getElementById('focusTimerToggle').addEventListener('change', (e) => {
                    settings.focusTimer = e.target.checked;
                    this.save();
                });
                
                document.getElementById('hapticToggle').addEventListener('change', (e) => {
                    settings.haptic = e.target.checked;
                    this.save();
                });
            },

            // --- Theme Engine ---
            setTheme(color, element) {
                document.documentElement.style.setProperty('--accent', color);
                document.documentElement.style.setProperty('--accent-dim', color + '20');
                this.data.settings.theme = color;
                this.save();

                // Visual selection
                document.querySelectorAll('.theme-dot').forEach(el => el.classList.remove('selected'));
                if(element) element.classList.add('selected');
            },

            loadTheme() {
                const savedColor = this.data.settings.theme || '#00ff9d';
                document.documentElement.style.setProperty('--accent', savedColor);
                document.documentElement.style.setProperty('--accent-dim', savedColor + '20');
                
                // Select the theme dot
                document.querySelectorAll('.theme-dot').forEach(d => {
                    if(d.style.backgroundColor.includes(savedColor)) {
                        d.classList.add('selected');
                    }
                });
            },

            // --- Backup & Restore ---
            exportData() {
                const dataStr = JSON.stringify(this.data);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', 'atomic_backup_' + new Date().toISOString().slice(0,10) + '.json');
                linkElement.click();
            },

            restoreData(input) {
                const file = input.files[0];
                if(!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if(json.habits && Array.isArray(json.habits)) {
                            if(confirm("This will overwrite your current system. Continue?")) {
                                this.data = json;
                                this.save();
                                this.renderList();
                                this.renderDashboard();
                                this.renderAchievements();
                                alert("System Restored Successfully!");
                                document.getElementById('settingsModal').style.display = 'none';
                            }
                        } else {
                            alert("Invalid backup file.");
                        }
                    } catch(err) {
                        alert("Error reading file: " + err.message);
                    }
                };
                reader.readAsText(file);
            },

            resetData() {
                if(confirm('FACTORY RESET: This deletes all data permanently. Are you sure?')) {
                    localStorage.removeItem('atomicV8');
                    location.reload();
                }
            },

            // --- Dashboard & Stats ---
            updateStats() {
                const today = this.getTodayString();
                const habits = this.data.habits;
                
                // Today's completion
                const completedToday = habits.filter(h => h.logs && h.logs[today]).length;
                const todayCompletion = habits.length > 0 ? Math.round((completedToday / habits.length) * 100) : 0;
                
                // Current streak
                let currentStreak = 0;
                const checkDate = new Date();
                checkDate.setHours(0,0,0,0);
                
                while(true) {
                    const dateStr = this.getISOString(checkDate);
                    const completedOnDay = habits.filter(h => h.logs && h.logs[dateStr]).length;
                    
                    if(completedOnDay > 0 && completedOnDay >= Math.min(habits.length, 1)) {
                        currentStreak++;
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else {
                        break;
                    }
                }
                
                // Best streak (simplified)
                let bestStreak = currentStreak;
                
                // Success rate (last 30 days)
                let successDays = 0;
                let totalDays = 0;
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                for(let d = new Date(thirtyDaysAgo); d <= new Date(); d.setDate(d.getDate() + 1)) {
                    const dateStr = this.getISOString(d);
                    const completedOnDay = habits.filter(h => h.logs && h.logs[dateStr]).length;
                    if(completedOnDay > 0) successDays++;
                    totalDays++;
                }
                
                const successRate = totalDays > 0 ? Math.round((successDays / totalDays) * 100) : 0;
                
                // Update stats object
                this.data.stats = {
                    todayCompletion,
                    currentStreak,
                    bestStreak,
                    successRate,
                    totalHabits: habits.length,
                    totalCompletions: this.calculateTotalCompletions(),
                    lastActiveDate: today
                };
            },

            renderDashboard() {
                const stats = this.data.stats;
                
                document.getElementById('todayCompletion').textContent = stats.todayCompletion + '%';
                document.getElementById('currentStreak').textContent = stats.currentStreak;
                document.getElementById('totalHabits').textContent = stats.totalHabits;
                document.getElementById('successRate').textContent = stats.successRate + '%';
            },

            updateAnalytics() {
                const stats = this.data.stats;
                
                document.getElementById('totalCompletions').textContent = stats.totalCompletions;
                document.getElementById('bestStreak').textContent = stats.bestStreak;
                document.getElementById('avgCompletion').textContent = stats.successRate + '%';
                document.getElementById('consistencyScore').textContent = Math.min(100, stats.currentStreak * 10) + '%';
                
                // Render heatmap
                this.renderHeatmap();
                
                // Render time chart
                this.renderTimeChart();
            },

            // PART 3 CONTINUES...
                        renderHeatmap() {
                const heatmapEl = document.getElementById('weeklyHeatmap');
                heatmapEl.innerHTML = '';
                
                const today = new Date();
                const totalHabits = this.data.habits.length || 1;
                let activeDaysCount = 0;
                let maxCompletions = 0;
                let bestDateStr = '--';

                // Create 365-day grid
                for (let i = 364; i >= 0; i--) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'heatmap-day';
                    
                    const date = new Date();
                    date.setDate(today.getDate() - i);
                    const dateStr = this.getISOString(date);
                    
                    const completions = this.data.habits.filter(h => 
                        h.logs && h.logs[dateStr]
                    ).length;
                    
                    if (completions > 0) {
                        activeDaysCount++;
                        if (completions > maxCompletions) {
                            maxCompletions = completions;
                            bestDateStr = date.toLocaleDateString();
                        }

                        const ratio = completions / totalHabits;
                        let level = 1;
                        if (ratio > 0.8) level = 5;
                        else if (ratio > 0.6) level = 4;
                        else if (ratio > 0.4) level = 3;
                        else if (ratio > 0.2) level = 2;
                        
                        dayEl.classList.add(`active-${level}`);
                    }

                    const title = `${date.toLocaleDateString()}: ${completions} habits completed`;
                    
                    dayEl.addEventListener('mouseenter', (e) => this.showTooltip(e, title));
                    dayEl.addEventListener('mouseleave', () => this.hideTooltip());
                    dayEl.addEventListener('touchstart', (e) => {
                        this.showTooltip(e, title);
                        setTimeout(() => this.hideTooltip(), 2000);
                    }, {passive: true});
                    
                    heatmapEl.appendChild(dayEl);
                }

                document.getElementById('activeDays').textContent = activeDaysCount;
                document.getElementById('bestDay').textContent = maxCompletions > 0 ? `${maxCompletions} (${bestDateStr})` : '--';
            },

            showTooltip(e, text) {
                const tt = document.getElementById('tooltip');
                tt.style.display = 'block';
                tt.innerHTML = text;
                const rect = e.target.getBoundingClientRect();
                tt.style.left = (rect.left + rect.width/2) + 'px';
                tt.style.top = rect.top + 'px';
            },

            hideTooltip() {
                const tt = document.getElementById('tooltip');
                if (tt) tt.style.display = 'none';
            },

            renderTimeChart() {
                const timeChart = document.getElementById('timeChart');
                timeChart.innerHTML = '';
                
                // Mock data for time distribution (would be real in production)
                const hours = ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM'];
                const values = [80, 60, 40, 30, 50, 20];
                
                hours.forEach((hour, index) => {
                    const bar = document.createElement('div');
                    bar.style.flex = '1';
                    bar.style.display = 'flex';
                    bar.style.flexDirection = 'column';
                    bar.style.alignItems = 'center';
                    
                    const barFill = document.createElement('div');
                    barFill.style.width = '100%';
                    barFill.style.backgroundColor = 'var(--accent)';
                    barFill.style.borderRadius = '4px 4px 0 0';
                    barFill.style.height = `${values[index]}%`;
                    barFill.style.transition = 'height 0.5s ease';
                    
                    const label = document.createElement('div');
                    label.textContent = hour;
                    label.style.fontSize = '0.7rem';
                    label.style.color = 'var(--text-secondary)';
                    label.style.marginTop = '4px';
                    
                    bar.appendChild(barFill);
                    bar.appendChild(label);
                    timeChart.appendChild(bar);
                });
            },

            // --- Habit List Rendering ---
            renderList() {
                const list = document.getElementById('habitList');
                const empty = document.getElementById('emptyState');
                list.innerHTML = '';
                
                const today = this.getTodayString();
                const settings = this.data.settings;
                
                // Sort habits
                let sorted = [...this.data.habits];
                
                switch(settings.sortBy) {
                    case 'priority':
                        sorted.sort((a,b) => (b.priority || 3) - (a.priority || 3));
                        break;
                    case 'streak':
                        sorted.sort((a,b) => this.calculateStreak(b) - this.calculateStreak(a));
                        break;
                    case 'alphabetical':
                        sorted.sort((a,b) => a.name.localeCompare(b.name));
                        break;
                }
                
                // Filter completed if needed
                if (!settings.showCompleted) {
                    sorted = sorted.filter(h => !h.logs || !h.logs[today]);
                }
                
                if(sorted.length === 0) {
                    empty.style.display = 'block';
                    return;
                }
                empty.style.display = 'none';

                sorted.forEach(habit => {
                    const isDone = habit.logs && habit.logs[today];
                    const hasNote = habit.notes && habit.notes[today];
                    const streak = this.calculateStreak(habit);
                    const priority = habit.priority || 3;
                    const priorityClass = priority >= 4 ? 'high' : priority >= 2 ? 'medium' : 'low';
                    
                    const li = document.createElement('li');
                    li.className = `habit-item`;
                    li.setAttribute('data-id', habit.id);
                    li.setAttribute('data-type', habit.type || 'good');
                    
                    li.innerHTML = `
                        <div class="swipe-bg-right">‚úì Complete</div>
                        <div class="swipe-bg-left">üóë Delete</div>
                        <div class="habit-content">
                            <div style="font-size: 1.5rem; opacity: ${isDone ? 0.3 : 0.8}; color: var(--accent);">
                                ${isDone ? '‚òë' : '‚òê'}
                            </div>
                            <div class="habit-info">
                                <div class="habit-name">
                                    <span>${habit.name}</span>
                                    <span class="priority-stars">${'‚≠ê'.repeat(priority)}</span>
                                    ${habit.goal ? `<span class="goal-badge">Goal: ${habit.goal}</span>` : ''}
                                </div>
                                <div class="habit-meta">
                                    ${habit.identity ? `<span class="identity-pill">${habit.identity}</span>` : ''}
                                    ${habit.category ? `<span class="category-pill">${this.getCategoryEmoji(habit.category)} ${habit.category}</span>` : ''}
                                    <span style="color: #f59e0b">üî• ${streak}</span>
                                    ${habit.difficulty === 'easy' ? '<span style="color:#10b981">‚úì Easy</span>' : ''}
                                    ${habit.difficulty === 'hard' ? '<span style="color:#ef4444">‚ö° Hard</span>' : ''}
                                    ${hasNote ? '<span style="color:var(--accent)">‚úçÔ∏è Reflecting</span>' : ''}
                                </div>
                                <div class="habit-progress">
                                    <div class="habit-progress-bar" style="width: ${this.calculateWeeklyCompletion(habit)}%"></div>
                                </div>
                                <div class="quick-actions">
                                    <button class="quick-btn" onclick="window.app.editHabit('${habit.id}')">Edit</button>
                                    ${!isDone ? `<button class="quick-btn" onclick="window.app.toggleHabit('${habit.id}')" style="color:var(--accent);">Mark Done</button>` : ''}
                                    <button class="quick-btn" onclick="window.app.openNoteModal('${habit.id}')">‚úçÔ∏è Note</button>
                                    ${habit.timerDuration ? `<button class="quick-btn" onclick="window.app.startFocusModeForHabit('${habit.id}')" style="color:var(--info);">‚è±Ô∏è ${habit.timerDuration}m</button>` : ''}
                                    ${habit.reminder ? `<button class="quick-btn">‚è∞ ${habit.reminder}</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    this.attachGestures(li, habit.id);
                    list.appendChild(li);
                });
            },

            getCategoryEmoji(category) {
                const emojis = {
                    'health': 'üè•',
                    'work': 'üíº',
                    'learning': 'üìö',
                    'mindfulness': 'üßò',
                    'relationships': '‚ù§Ô∏è',
                    'finance': 'üí∞',
                    'creativity': 'üé®',
                    'other': 'üì¶'
                };
                return emojis[category] || 'üìå';
            },

            calculateWeeklyCompletion(habit) {
                let completed = 0;
                for (let i = 0; i < 7; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = this.getISOString(date);
                    if (habit.logs && habit.logs[dateStr]) {
                        completed++;
                    }
                }
                return Math.round((completed / 7) * 100);
            },

            calculateTotalCompletions() {
                let total = 0;
                this.data.habits.forEach(habit => {
                    if (habit.logs) {
                        total += Object.keys(habit.logs).length;
                    }
                });
                return total;
            },

            attachGestures(element, id) {
                let startX, currentX, isDragging = false, longPressTimer;

                element.addEventListener('touchstart', (e) => {
                    if (this.data.settings.haptic && navigator.vibrate) {
                        navigator.vibrate(10);
                    }
                    
                    startX = e.touches[0].clientX;
                    isDragging = false;
                    longPressTimer = setTimeout(() => {
                        this.hapticBump(element);
                        this.editHabit(id);
                        element.style.transform = 'translateX(0)'; 
                    }, 600); 
                }, {passive: true});

                element.addEventListener('touchmove', (e) => {
                    clearTimeout(longPressTimer);
                    currentX = e.touches[0].clientX;
                    const diffX = currentX - startX;
                    
                    if(Math.abs(diffX) > 10) {
                        isDragging = true;
                        element.classList.add('swiping');
                        element.style.transform = `translateX(${diffX}px)`;
                        
                        const opacity = Math.min(Math.abs(diffX) / 100, 1);
                        const bgRight = element.querySelector('.swipe-bg-right');
                        const bgLeft = element.querySelector('.swipe-bg-left');
                        
                        if(diffX > 0) { 
                            bgRight.style.opacity = opacity; 
                            bgLeft.style.opacity = 0; 
                        } else { 
                            bgLeft.style.opacity = opacity; 
                            bgRight.style.opacity = 0; 
                        }
                    }
                }, {passive: true});

                element.addEventListener('touchend', (e) => {
                    clearTimeout(longPressTimer);
                    if(!isDragging) {
                        // Single tap - toggle completion
                        this.toggleHabit(id);
                    } else {
                        const diffX = currentX - startX;
                        const threshold = 80;

                        if (diffX > threshold) {
                            this.completeAction(element, id);
                        } else if (diffX < -threshold) {
                            this.deleteAction(element, id);
                        } else {
                            element.classList.remove('swiping');
                            element.style.transform = 'translateX(0)';
                            element.querySelector('.swipe-bg-right').style.opacity = 0;
                            element.querySelector('.swipe-bg-left').style.opacity = 0;
                        }
                    }
                });
            },

            completeAction(el, id) {
                el.style.transform = 'translateX(100%)';
                this.toggleHabit(id, true);
            },
            
            deleteAction(el, id) {
                el.style.transform = 'translateX(-100%)';
                setTimeout(() => { this.deleteHabit(id); }, 200);
            },

            hapticBump(el) {
                if (this.data.settings.haptic && navigator.vibrate) {
                    navigator.vibrate([20, 10, 20]);
                }
                el.style.animation = 'bounce 0.3s';
                setTimeout(() => el.style.animation = '', 300);
            },

            toggleHabit(id, isSwipe = false) {
                const habit = this.data.habits.find(h => h.id === id);
                if(!habit) return;
                const today = this.getTodayString();
                if(!habit.logs) habit.logs = {};
                
                if(habit.logs[today]) {
                    delete habit.logs[today];
                } else {
                    habit.logs[today] = true;
                    if(!isSwipe) {
                        this.fireConfetti();
                        // Check for achievement: perfect day
                        this.checkPerfectDay();
                    }
                    // Haptic Feedback
                    if(this.data.settings.haptic && navigator.vibrate) navigator.vibrate(20);
                    
                    // Send notification if enabled
                    this.sendCompletionNotification(habit);
                }
                this.save();
                this.renderList();
                this.updateAnalytics();
            },

            deleteHabit(id) {
                if(confirm('Delete this habit permanently?')) {
                    this.data.habits = this.data.habits.filter(h => h.id !== id);
                    this.save();
                    this.renderList();
                    this.renderDashboard();
                }
            },

            // --- Focus Mode ---
            startFocusMode() {
                const today = this.getTodayString();
                const incomplete = this.data.habits.filter(h => !h.logs || !h.logs[today]);
                
                if(incomplete.length === 0) {
                    this.showNotification("All habits completed! Great work!", "success");
                    return;
                }
                
                this.currentFocusIndex = 0;
                this.showFocusItem(incomplete[0]);
                document.getElementById('focusOverlay').classList.add('active');
                document.getElementById('focusSessions').textContent = this.data.stats.focusSessionsToday || 0;
                
                // Reset pomodoro timer
                this.resetPomodoro();
            },

            startFocusModeForHabit(id) {
                const habit = this.data.habits.find(h => h.id === id);
                if(!habit) return;

                this.currentFocusId = id;
                this.showFocusItem(habit);
                document.getElementById('focusOverlay').classList.add('active');
                document.getElementById('focusSessions').textContent = this.data.stats.focusSessionsToday || 0;
            },

            showFocusItem(habit) {
                const nameEl = document.getElementById('focusHabitName');
                nameEl.style.opacity = 0;
                setTimeout(() => {
                    nameEl.textContent = habit.name;
                    nameEl.style.opacity = 1;
                }, 200);
                this.currentFocusId = habit.id;
                this.resetPomodoro();
            },

            focusComplete() {
                this.toggleHabit(this.currentFocusId, false);
                const today = this.getTodayString();
                const incomplete = this.data.habits.filter(h => !h.logs || !h.logs[today]);
                if(incomplete.length > 0) {
                    this.showFocusItem(incomplete[0]);
                } else {
                    this.stopFocusMode();
                    this.showNotification("All habits completed!", "success");
                }
                
                // Track focus session
                this.data.stats.focusSessionsToday = (this.data.stats.focusSessionsToday || 0) + 1;
                this.save();
            },

            focusSkip() {
                const today = this.getTodayString();
                const incomplete = this.data.habits.filter(h => !h.logs || !h.logs[today]);
                const currentIdx = incomplete.findIndex(h => h.id === this.currentFocusId);
                if(currentIdx < incomplete.length - 1) {
                    this.showFocusItem(incomplete[currentIdx + 1]);
                } else {
                    this.stopFocusMode();
                }
            },

            stopFocusMode() {
                document.getElementById('focusOverlay').classList.remove('active');
                this.renderList();
                this.stopPomodoro();
            },

            // --- Pomodoro Timer ---
            startPomodoro() {
                if (this.pomodoroRunning) return;
                
                this.pomodoroRunning = true;
                document.getElementById('startTimerBtn').style.display = 'none';
                document.getElementById('pauseTimerBtn').style.display = 'block';
                
                this.pomodoroInterval = setInterval(() => {
                    this.pomodoroTime--;
                    this.updatePomodoroDisplay();
                    
                    if (this.pomodoroTime <= 0) {
                        this.pomodoroComplete();
                    }
                }, 1000);
            },

            pausePomodoro() {
                this.pomodoroRunning = false;
                clearInterval(this.pomodoroInterval);
                document.getElementById('startTimerBtn').style.display = 'block';
                document.getElementById('pauseTimerBtn').style.display = 'none';
            },

            resetPomodoro() {
                this.pausePomodoro();
                const habit = this.data.habits.find(h => h.id === this.currentFocusId);
                const duration = habit && habit.timerDuration ? habit.timerDuration : (this.data.settings.pomodoroLength || 25);
                this.pomodoroTime = duration * 60;
                this.updatePomodoroDisplay();
            },

            updatePomodoroDisplay() {
                const minutes = Math.floor(this.pomodoroTime / 60);
                const seconds = this.pomodoroTime % 60;
                document.getElementById('pomodoroTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            },

            pomodoroComplete() {
                this.pausePomodoro();
                this.showNotification("Focus session complete! Take a break.", "success");
                
                // Vibrate if enabled
                if (this.data.settings.haptic && navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
            },

            stopPomodoro() {
                this.pausePomodoro();
                this.resetPomodoro();
            },

            // --- Achievements ---
            renderAchievements() {
                const grid = document.getElementById('achievementsGrid');
                const empty = document.getElementById('noAchievements');
                grid.innerHTML = '';
                
                const achievements = this.data.achievements || this.achievementsDef;
                
                if (achievements.length === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                empty.style.display = 'none';
                
                achievements.forEach(achievement => {
                    const badge = document.createElement('div');
                    badge.className = `achievement-badge ${achievement.unlocked ? '' : 'locked'}`;
                    badge.innerHTML = `
                        <div class="badge-icon">${achievement.icon}</div>
                        <div class="badge-title">${achievement.title}</div>
                        <div class="badge-desc">${achievement.desc}</div>
                        ${achievement.unlocked ? '<div style="margin-top: 0.5rem; font-size: 0.6rem; color: var(--accent);">‚úì Unlocked</div>' : ''}
                    `;
                    grid.appendChild(badge);
                });
            },

            checkAchievements() {
                const achievements = this.data.achievements || this.achievementsDef;
                let unlockedNew = false;
                
                // Check each achievement
                achievements.forEach(achievement => {
                    if (achievement.unlocked) return;
                    
                    let unlocked = false;
                    
                    switch(achievement.id) {
                        case 'first_habit':
                            unlocked = this.data.habits.length > 0;
                            break;
                        case 'streak_3':
                            unlocked = this.data.stats.currentStreak >= 3;
                            break;
                        case 'streak_7':
                            unlocked = this.data.stats.currentStreak >= 7;
                            break;
                        case 'streak_30':
                            unlocked = this.data.stats.currentStreak >= 30;
                            break;
                        case 'complete_all':
                            const today = this.getTodayString();
                            const completedToday = this.data.habits.filter(h => h.logs && h.logs[today]).length;
                            unlocked = this.data.habits.length > 0 && completedToday === this.data.habits.length;
                            break;
                        case 'habit_stacker':
                            unlocked = this.data.stacks.length >= 3;
                            break;
                        default:
                            unlocked = false;
                    }
                    
                    if (unlocked && !achievement.unlocked) {
                        achievement.unlocked = true;
                        unlockedNew = true;
                        this.showAchievementPopup(achievement);
                    }
                });
                
                if (unlockedNew) {
                    this.save();
                    this.renderAchievements();
                }
            },

            checkPerfectDay() {
                const today = this.getTodayString();
                const completedToday = this.data.habits.filter(h => h.logs && h.logs[today]).length;
                
                if (this.data.habits.length > 0 && completedToday === this.data.habits.length) {
                    // Check if "complete_all" achievement exists and isn't unlocked
                    const achievement = this.data.achievements.find(a => a.id === 'complete_all');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        this.showAchievementPopup(achievement);
                        this.save();
                        this.renderAchievements();
                    }
                }
            },

            showAchievementPopup(achievement) {
                document.getElementById('popupBadgeIcon').textContent = achievement.icon;
                document.getElementById('popupBadgeTitle').textContent = achievement.title;
                document.getElementById('popupBadgeDesc').textContent = achievement.desc;
                document.getElementById('achievementPopup').classList.add('active');
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    document.getElementById('achievementPopup').classList.remove('active');
                }, 5000);
                
                // Fire confetti
                this.fireConfetti();
            },

            // PART 4 CONTINUES...
                        // --- Habit Stacks ---
            renderStacks() {
                const stacksList = document.getElementById('stacksList');
                const empty = document.getElementById('noStacks');
                stacksList.innerHTML = '';
                
                if (this.data.stacks.length === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                empty.style.display = 'none';
                
                this.data.stacks.forEach(stack => {
                    const stackEl = document.createElement('div');
                    stackEl.className = 'habit-item';
                    stackEl.style.marginBottom = '1rem';
                    
                    // Calculate completion for today
                    const today = this.getTodayString();
                    const habitIds = stack.habits || [];
                    const stackHabits = this.data.habits.filter(h => habitIds.includes(h.id));
                    const completedCount = stackHabits.filter(h => h.logs && h.logs[today]).length;
                    const totalCount = stackHabits.length;
                    const completionPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                    
                    stackEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 4px;">${stack.name}</div>
                                ${stack.description ? `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">${stack.description}</div>` : ''}
                                ${stack.trigger ? `<div style="font-size: 0.75rem; color: var(--accent);">‚ö° After: ${stack.trigger}</div>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${completionPercent}%</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">${completedCount}/${totalCount}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px;">
                            <div class="habit-progress">
                                <div class="habit-progress-bar" style="width: ${completionPercent}%"></div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px; display: flex; gap: 0.5rem;">
                            <button class="quick-btn" onclick="window.app.editStack('${stack.id}')">Edit</button>
                            <button class="quick-btn" onclick="window.app.completeStack('${stack.id}')" 
                                style="color: var(--accent); ${completedCount === totalCount && totalCount > 0 ? 'display:none' : ''}">
                                Complete All
                            </button>
                            ${completionPercent === 100 ? '<span style="color: var(--accent); font-size: 0.8rem;">‚úì Stack Complete</span>' : ''}
                        </div>
                        
                        <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 0.3rem;">
                            ${stackHabits.map(h => `
                                <span class="badge" style="font-size: 0.6rem; background: rgba(255,255,255,0.05);">
                                    ${h.logs && h.logs[today] ? '‚úì ' : ''}${h.name}
                                </span>
                            `).join('')}
                        </div>
                    `;
                    stacksList.appendChild(stackEl);
                });
            },

            openStackModal(stackId = null) {
                const modal = document.getElementById('stackModal');
                const title = document.getElementById('stackModalTitle');
                const form = document.getElementById('stackForm');
                const selector = document.getElementById('stackHabitSelector');
                
                selector.innerHTML = '';
                
                // Populate habit checklist
                this.data.habits.forEach(habit => {
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.marginBottom = '0.5rem';
                    div.style.padding = '0.5rem';
                    div.style.background = 'rgba(255,255,255,0.02)';
                    div.style.borderRadius = '8px';
                    
                    div.innerHTML = `
                        <input type="checkbox" id="habit_${habit.id}" value="${habit.id}" 
                               style="margin-right: 0.5rem;">
                        <label for="habit_${habit.id}" style="flex:1;">${habit.name}</label>
                    `;
                    selector.appendChild(div);
                });
                
                if (stackId) {
                    // Edit mode
                    title.textContent = 'Edit Stack';
                    const stack = this.data.stacks.find(s => s.id === stackId);
                    document.getElementById('stackId').value = stack.id;
                    document.getElementById('stackName').value = stack.name;
                    document.getElementById('stackDescription').value = stack.description || '';
                    document.getElementById('stackTrigger').value = stack.trigger || '';
                    
                    // Check selected habits
                    stack.habits.forEach(habitId => {
                        const checkbox = document.getElementById(`habit_${habitId}`);
                        if (checkbox) checkbox.checked = true;
                    });
                } else {
                    // Create mode
                    title.textContent = 'Create Stack';
                    document.getElementById('stackId').value = '';
                    document.getElementById('stackName').value = '';
                    document.getElementById('stackDescription').value = '';
                    document.getElementById('stackTrigger').value = '';
                }
                
                modal.style.display = 'flex';
            },

            editStack(id) {
                this.openStackModal(id);
            },

            completeStack(stackId) {
                const stack = this.data.stacks.find(s => s.id === stackId);
                if (!stack) return;
                
                const today = this.getTodayString();
                stack.habits.forEach(habitId => {
                    const habit = this.data.habits.find(h => h.id === habitId);
                    if (habit) {
                        if (!habit.logs) habit.logs = {};
                        if (!habit.logs[today]) {
                            habit.logs[today] = true;
                        }
                    }
                });
                
                this.save();
                this.renderList();
                this.renderStacks();
                
                this.showNotification("Stack completed!", "success");
            },

            // --- Note/Journal Logic ---
            openNoteModal(id) {
                const habit = this.data.habits.find(h => h.id == id);
                if(!habit) return;

                this.currentNoteHabitId = id;
                const today = this.getTodayString();
                const existingNote = habit.notes && habit.notes[today] ? habit.notes[today] : '';
                
                document.getElementById('noteHabitName').textContent = habit.name;
                document.getElementById('noteTextarea').value = existingNote;
                document.getElementById('noteModal').style.display = 'flex';
            },

            saveNote() {
                const habit = this.data.habits.find(h => h.id == this.currentNoteHabitId);
                if(!habit) return;

                const today = this.getTodayString();
                const text = document.getElementById('noteTextarea').value;

                if(!habit.notes) habit.notes = {};
                habit.notes[today] = text;

                this.save();
                document.getElementById('noteModal').style.display = 'none';
                this.renderList();
                this.showNotification("Reflection saved", "success");
            },

            // --- Modal Handling ---
            setupEventListeners() {
                // Habit form submission
                document.getElementById('habitForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = document.getElementById('habitId').value;
                    const name = document.getElementById('habitName').value;
                    const identity = document.getElementById('habitIdentity').value;
                    const priority = parseInt(document.getElementById('habitPriority').value);
                    const type = document.getElementById('habitType').value;
                    const goal = parseInt(document.getElementById('habitGoal').value) || 1;
                    const category = document.getElementById('habitCategory').value;
                    const difficulty = document.getElementById('habitDifficulty').value;
                    const reminder = document.getElementById('habitReminder').value;
                    const timer = parseInt(document.getElementById('habitTimer').value) || 25;

                    if (id) {
                        // Edit existing habit
                        const h = this.data.habits.find(x => x.id == id);
                        h.name = name;
                        h.identity = identity;
                        h.priority = priority;
                        h.type = type;
                        h.goal = goal;
                        h.category = category;
                        h.difficulty = difficulty;
                        h.reminder = reminder;
                        h.timerDuration = timer;
                    } else {
                        // Add new habit
                        this.data.habits.push({
                            id: Date.now().toString(),
                            name: name,
                            identity: identity,
                            priority: priority,
                            type: type,
                            goal: goal,
                            category: category,
                            difficulty: difficulty,
                            reminder: reminder || null,
                            timerDuration: timer,
                            logs: {},
                            createdAt: Date.now()
                        });
                        
                        // Check for first habit achievement
                        setTimeout(() => this.checkAchievements(), 500);
                    }
                    
                    this.save();
                    this.renderList();
                    this.closeModal(null, 'addModal');
                    
                    // Show success message
                    this.showNotification(id ? "Habit updated" : "Habit added", "success");
                });

                // Stack form submission
                document.getElementById('stackForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = document.getElementById('stackId').value;
                    const name = document.getElementById('stackName').value;
                    const description = document.getElementById('stackDescription').value;
                    const trigger = document.getElementById('stackTrigger').value;
                    
                    // Get selected habit IDs
                    const selectedHabits = [];
                    document.querySelectorAll('#stackHabitSelector input[type="checkbox"]:checked').forEach(cb => {
                        selectedHabits.push(cb.value);
                    });
                    
                    if (id) {
                        // Edit existing stack
                        const stack = this.data.stacks.find(s => s.id === id);
                        stack.name = name;
                        stack.description = description;
                        stack.trigger = trigger;
                        stack.habits = selectedHabits;
                    } else {
                        // Add new stack
                        this.data.stacks.push({
                            id: Date.now().toString(),
                            name: name,
                            description: description,
                            trigger: trigger,
                            habits: selectedHabits,
                            createdAt: Date.now()
                        });
                    }
                    
                    this.save();
                    this.renderStacks();
                    this.closeModal(null, 'stackModal');
                    this.checkAchievements(); // Check for stacker achievement
                    
                    this.showNotification("Stack saved", "success");
                });
            },

            openQuickAdd() {
                document.getElementById('quickAddModal').style.display = 'flex';
                document.getElementById('quickHabitName').focus();
            },

            saveQuickHabit() {
                const name = document.getElementById('quickHabitName').value;
                if (!name.trim()) return;
                
                this.data.habits.push({
                    id: Date.now().toString(),
                    name: name,
                    priority: 3,
                    category: 'other',
                    difficulty: 'medium',
                    logs: {},
                    createdAt: Date.now()
                });
                
                this.save();
                this.renderList();
                this.renderDashboard();
                document.getElementById('quickHabitName').value = '';
                
                // Keep modal open for quick adding
                document.getElementById('quickHabitName').focus();
                
                this.showNotification("Habit added", "success");
            },

            openAddModal() {
                document.getElementById('modalTitle').textContent = "New Atomic Habit";
                document.getElementById('habitId').value = '';
                document.getElementById('habitName').value = '';
                document.getElementById('habitIdentity').value = '';
                document.getElementById('habitPriority').value = '3';
                document.getElementById('habitType').value = 'good';
                document.getElementById('habitGoal').value = '1';
                document.getElementById('habitCategory').value = 'health';
                document.getElementById('habitDifficulty').value = 'medium';
                document.getElementById('habitReminder').value = '09:00';
                document.getElementById('habitTimer').value = '25';
                document.getElementById('addModal').style.display = 'flex';
            },

            editHabit(id) {
                const h = this.data.habits.find(x => x.id === id);
                if(!h) return;
                
                document.getElementById('modalTitle').textContent = "Edit Protocol";
                document.getElementById('habitId').value = h.id;
                document.getElementById('habitName').value = h.name;
                document.getElementById('habitIdentity').value = h.identity || '';
                document.getElementById('habitPriority').value = h.priority || '3';
                document.getElementById('habitType').value = h.type || 'good';
                document.getElementById('habitGoal').value = h.goal || '1';
                document.getElementById('habitCategory').value = h.category || 'other';
                document.getElementById('habitDifficulty').value = h.difficulty || 'medium';
                document.getElementById('habitReminder').value = h.reminder || '09:00';
                document.getElementById('habitTimer').value = h.timerDuration || '25';
                document.getElementById('addModal').style.display = 'flex';
            },

            closeModal(e, modalId) {
                if(!e || e.target.id === modalId) {
                    document.getElementById(modalId).style.display = 'none';
                }
            },

            openSettings() {
                document.getElementById('settingsModal').style.display = 'flex';
            },

            // --- View Switching ---
            switchView(view) {
                // Update nav items
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                    if (nav.dataset.view === view) {
                        nav.classList.add('active');
                    }
                });
                
                // Show corresponding view
                document.querySelectorAll('.view-container').forEach(container => {
                    container.classList.remove('active');
                });
                
                if (document.getElementById(view + 'View')) {
                    document.getElementById(view + 'View').classList.add('active');
                }
                
                // Update data for view
                if (view === 'analytics') {
                    this.updateAnalytics();
                } else if (view === 'achievements') {
                    this.renderAchievements();
                } else if (view === 'stacks') {
                    this.renderStacks();
                }
                
                this.currentView = view;
                if(this.data.settings.haptic && navigator.vibrate) navigator.vibrate(5);
            },

            // --- Notification System ---
            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.background = type === 'success' ? 'var(--accent)' : 
                                               type === 'error' ? 'var(--danger)' : '#333';
                notification.style.color = 'white';
                notification.style.padding = '12px 16px';
                notification.style.borderRadius = '8px';
                notification.style.zIndex = '1000';
                notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                notification.style.transform = 'translateX(100px)';
                notification.style.opacity = '0';
                notification.style.transition = 'transform 0.3s, opacity 0.3s';
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                    notification.style.opacity = '1';
                }, 10);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.transform = 'translateX(100px)';
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            },

            sendCompletionNotification(habit) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    const notification = new Notification('Atomic Habit', {
                        body: `Completed: ${habit.name}`,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%2300ff9d"/><text x="50" y="60" text-anchor="middle" font-size="40">‚úì</text></svg>',
                        tag: 'habit-completion'
                    });
                    
                    // Close notification after 3 seconds
                    setTimeout(() => notification.close(), 3000);
                }
            },

            // --- Utilities ---
            updateGreeting() {
                const hour = new Date().getHours();
                const greeting = document.getElementById('greeting');
                if(hour < 12) greeting.textContent = "Good Morning";
                else if(hour < 18) greeting.textContent = "Good Afternoon";
                else greeting.textContent = "Good Evening";
            },

            getTodayString() {
                const d = new Date();
                return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,'0') + "-" + String(d.getDate()).padStart(2,'0');
            },
            
            getISOString(d) {
                return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,'0') + "-" + String(d.getDate()).padStart(2,'0');
            },
            
            calculateStreak(habit) {
                let streak = 0;
                const today = new Date();
                const checkDate = new Date(today);
                checkDate.setHours(0,0,0,0);
                
                // If today is not completed, start from yesterday
                if(!habit.logs || !habit.logs[this.getISOString(checkDate)]) {
                    checkDate.setDate(checkDate.getDate() - 1);
                }
                
                // Count consecutive completed days
                while(true) {
                    const dateStr = this.getISOString(checkDate);
                    if(habit.logs && habit.logs[dateStr]) { 
                        streak++; 
                        checkDate.setDate(checkDate.getDate() - 1); 
                    } else { 
                        break; 
                    }
                }
                
                return streak;
            },

            fireConfetti() {
                const c = document.getElementById('confetti');
                const ctx = c.getContext('2d');
                c.width = window.innerWidth; 
                c.height = window.innerHeight;
                
                const particles = [];
                const colors = [
                    getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),
                    '#3b82f6',
                    '#f59e0b',
                    '#ec4899',
                    '#10b981'
                ];
                
                // Create particles
                for(let i = 0; i < 100; i++) {
                    particles.push({
                        x: c.width / 2,
                        y: c.height / 2,
                        dx: (Math.random() - 0.5) * 20,
                        dy: (Math.random() - 0.5) * 20 - 5,
                        life: 100,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        size: Math.random() * 8 + 4,
                        shape: Math.random() > 0.5 ? 'circle' : 'rect'
                    });
                }
                
                const animate = () => {
                    ctx.clearRect(0, 0, c.width, c.height);
                    
                    let alive = false;
                    
                    particles.forEach(p => {
                        if(p.life > 0) { 
                            p.x += p.dx;
                            p.y += p.dy;
                            p.dy += 0.3; // Gravity
                            p.dx *= 0.98; // Air resistance
                            p.life--;
                            
                            ctx.fillStyle = p.color;
                            ctx.globalAlpha = p.life / 100;
                            
                            if(p.shape === 'circle') {
                                ctx.beginPath();
                                ctx.arc(p.x, p.y, p.size / 2, 0, Math.PI * 2);
                                ctx.fill();
                            } else {
                                ctx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
                            }
                            
                            alive = true;
                        }
                    });
                    
                    if(alive) {
                        requestAnimationFrame(animate);
                    } else {
                        ctx.clearRect(0, 0, c.width, c.height);
                    }
                };
                
                animate();
            },

            // Service Worker Registration (for PWA)
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js').catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
                }
            }
        };

        // Initialize app when page loads
        window.addEventListener('load', () => {
            window.app.init();
            
            // Register service worker in background
            setTimeout(() => {
                window.app.registerServiceWorker();
            }, 1000);
            
            // Add beforeunload listener to save data
            window.addEventListener('beforeunload', () => {
                window.app.save();
            });
            
            // Handle keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + N to add new habit
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    window.app.openAddModal();
                }
                
                // Escape to close modals
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal-overlay');
                    modals.forEach(modal => {
                        if (modal.style.display === 'flex') {
                            modal.style.display = 'none';
                        }
                    });
                }
            });
            
            // Handle online/offline status
            window.addEventListener('online', () => {
                window.app.showNotification("Back online", "success");
            });
            
            window.addEventListener('offline', () => {
                window.app.showNotification("Working offline", "info");
            });
        });

        // Service Worker content (basic offline support)
        const swContent = `
            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open('atomic-v8').then(cache => {
                        return cache.addAll([
                            '/',
                            '/index.html',
                            '/manifest.json'
                        ]);
                    })
                );
            });

            self.addEventListener('fetch', event => {
                event.respondWith(
                    caches.match(event.request).then(response => {
                        return response || fetch(event.request);
                    })
                );
            });
        `;

        // Create a blob URL for the service worker
        const swBlob = new Blob([swContent], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(swBlob);

        // Override the registerServiceWorker to use our blob URL
        window.app.registerServiceWorker = function() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            }
        };
    </script>

    <!-- Service Worker Registration -->
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content available, show update notification
                                    if (confirm('New version available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Handle PWA install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button or notification
            console.log('PWA install prompt available');
        });

        // Track successful installation
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed successfully');
            deferredPrompt = null;
        });
    </script>
</body>
</html>